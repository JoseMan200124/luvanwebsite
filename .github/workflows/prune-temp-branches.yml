name: Prune temp branches

on:
  schedule:
    - cron: "0 3 * * 0"
  workflow_dispatch: {}

permissions:
  contents: write
  pull-requests: read

jobs:
  prune:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/github-script@v7
        with:
          script: |
            const owner = context.repo.owner;
            const repo = context.repo.repo;

            const DAYS = 30;
            const cutoff = Date.now() - DAYS * 24 * 60 * 60 * 1000;

            const defaultBranch = context.payload.repository.default_branch;
            const protectedNames = new Set([defaultBranch, "main", "master", "develop", "staging"]);
            const allowedPrefixes = ["feat/", "fix/", "chore/", "docs/", "hotfix/"];

            const branches = await github.paginate(github.rest.repos.listBranches, {
              owner, repo, per_page: 100
            });

            for (const b of branches) {
              const name = b.name;

              if (protectedNames.has(name)) continue;
              if (name.startsWith("release/")) continue;
              if (b.protected) continue;
              if (!allowedPrefixes.some(p => name.startsWith(p))) continue;

              const openPrs = await github.rest.pulls.list({
                owner,
                repo,
                state: "open",
                head: `${owner}:${name}`,
                per_page: 1
              });
              if (openPrs.data.length > 0) continue;

              let commitDate;
              try {
                const commit = await github.rest.repos.getCommit({
                  owner,
                  repo,
                  ref: b.commit.sha
                });
                commitDate =
                  commit.data.commit.committer?.date ||
                  commit.data.commit.author?.date;
              } catch {
                continue;
              }
              const lastCommitTime = new Date(commitDate).getTime();
              if (Number.isNaN(lastCommitTime) || lastCommitTime > cutoff) continue;

              let aheadBy = 1;
              try {
                const cmp = await github.rest.repos.compareCommits({
                  owner,
                  repo,
                  base: defaultBranch,
                  head: name
                });
                aheadBy = cmp.data.ahead_by;
              } catch {
                continue;
              }
              if (aheadBy > 0) continue;

              try {
                await github.rest.git.deleteRef({
                  owner,
                  repo,
                  ref: `heads/${name}`
                });
              } catch {}
